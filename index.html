<!DOCTYPE html>
<html>
  <head>
    <title>Milk Sales Tracker</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.0.0/firebase-firestore.js"></script>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
        max-width: 500px;
        margin: auto;
      }
      select,
      input,
      button {
        width: 100%;
        padding: 10px;
        margin: 10px 0;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ¥› Milk Sales</h1>

    <!-- Customer Dropdown -->
    <select id="customerSelect">
      <option>Loading customers...</option>
    </select>

    <!-- Sales Input -->
    <input type="number" id="quantity" placeholder="Packets sold today" />
    <input type="number" id="costPerPacket" placeholder="Cost per packet (â‚¹)" />
    <button onclick="saveSale()">Generate Monthly Bill</button>

    <script>
      // ====================
      // Firebase Configuration (REPLACE WITH YOUR CONFIG)
      // ====================
      const firebaseConfig = {
        apiKey: "AIzaSyBqKLJjxZK0JNLcfDDdT6osUsLOZulSNJc",
        authDomain: "mummykabusiness1.firebaseapp.com",
        projectId: "mummykabusiness1",
        storageBucket: "mummykabusiness1.firebasestorage.app",
        messagingSenderId: "505480981906",
        appId: "1:505480981906:web:54dae6cff7f89f8cb8e54b",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // ====================
      // Load Customers (Fixes dropdown issue)
      // ====================
      function loadCustomers() {
        db.collection("customers")
          .get()
          .then((querySnapshot) => {
            const select = document.getElementById("customerSelect");
            select.innerHTML = "";

            // Add default option
            select.innerHTML += '<option value="">Select Customer</option>';

            // Add customers from Firebase
            querySnapshot.forEach((doc) => {
              const customer = doc.data();
              select.innerHTML += `
            <option value="${customer.phone}">
              ${customer.name}
            </option>
          `;
            });
          })
          .catch((error) => {
            console.error("Error loading customers:", error);
          });
      }

      // ====================
      // Get Monthly Sales
      // ====================
      async function getMonthlySales(customerName) {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

        const snapshot = await db
          .collection("sales")
          .where("customer", "==", customerName)
          .where("date", ">=", firstDay)
          .where("date", "<=", lastDay)
          .get();

        let totalPackets = 0;
        let totalCost = 0;

        snapshot.forEach((doc) => {
          const sale = doc.data();
          totalPackets += sale.quantity;
          totalCost += sale.totalCost;
        });

        return { totalPackets, totalCost };
      }

      // ====================
      // Save Sale and Send Bill
      // ====================
      async function saveSale() {
        const customerName =
          document.getElementById("customerSelect").selectedOptions[0].text;
        const phone = document.getElementById("customerSelect").value;
        const quantity = parseFloat(document.getElementById("quantity").value);
        const costPerPacket = parseFloat(
          document.getElementById("costPerPacket").value
        );

        if (!customerName || !phone) {
          alert("Please select a customer!");
          return;
        }

        // Save current sale
        await db.collection("sales").add({
          customer: customerName,
          quantity: quantity,
          costPerPacket: costPerPacket,
          totalCost: quantity * costPerPacket,
          date: new Date(),
        });

        // Get monthly total
        const { totalPackets, totalCost } = await getMonthlySales(customerName);
        const monthName = new Date().toLocaleString("default", {
          month: "long",
        });

        // Send WhatsApp message
        const message =
          `*${customerName}'s ${monthName} Milk Bill*\n\n` +
          `Total Packets: ${totalPackets}\n` +
          `Total Amount: â‚¹${totalCost.toFixed(2)}\n\n` +
          `Thank you! ðŸ¥›`;

        window.open(
          `https://wa.me/+91${phone}?text=${encodeURIComponent(message)}`,
          "_blank"
        );
      }

      // ====================
      // Initialize the App
      // ====================
      window.onload = function () {
        loadCustomers(); // Load customers when page opens
      };
    </script>
  </body>
</html>

